/**
 * Test cases for CVE-2025-56200
 * Tests the protocol parsing vulnerability fix in isURL()
 *
 * To add these to the main test suite, copy the test cases
 * into /Users/laptopname/validator.js/test/validators.test.js
 */

// Test helper function (mimics the one in validators.test.js)
function test(config) {
  const validator = require('./index');
  const validatorFn = validator[config.validator];
  const args = config.args || [];

  console.log(`\nTesting ${config.validator}${args.length ? ' with options' : ''}:`);

  if (config.valid) {
    console.log('  Valid URLs (should return true):');
    config.valid.forEach(url => {
      const result = validatorFn(url, ...args);
      const status = result ? '✓' : '✗ FAIL';
      console.log(`    ${status} ${url}`);
      if (!result) {
        console.log(`       ERROR: Expected true, got false`);
      }
    });
  }

  if (config.invalid) {
    console.log('  Invalid URLs (should return false):');
    config.invalid.forEach(url => {
      const result = validatorFn(url, ...args);
      const status = !result ? '✓' : '✗ FAIL';
      console.log(`    ${status} ${url}`);
      if (result) {
        console.log(`       ERROR: Expected false, got true`);
      }
    });
  }
}

console.log('='.repeat(80));
console.log('CVE-2025-56200 Test Suite');
console.log('Testing protocol parsing vulnerability fix in isURL()');
console.log('='.repeat(80));

// Test 1: Reject dangerous protocol URIs
console.log('\n' + '='.repeat(80));
console.log('Test 1: Reject dangerous protocol URIs (CVE-2025-56200)');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  valid: [
    // These should remain valid
    'http://example.com',
    'https://example.com',
    'ftp://example.com',
  ],
  invalid: [
    // XSS via javascript: protocol
    'javascript:alert(1)',
    'javascript:alert(document.cookie)',
    'javascript:alert(\'XSS\')',
    'javascript://example.com',
    'javascript://example.com/%0aalert(1)',
    'JavaScript:alert(1)', // case variation
    'JAVASCRIPT:alert(1)',

    // XSS via data: URIs
    'data:text/html,<script>alert(1)</script>',
    'data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==',
    'data:text/html,<h1>XSS</h1>',
    'data:image/svg+xml,<svg onload=alert(1)>',
    'data:application/x-javascript,alert(1)',

    // Legacy IE XSS
    'vbscript:msgbox(1)',
    'VBScript:msgbox(1)',

    // File disclosure
    'file:///etc/passwd',
    'file:///c:/windows/system.ini',
    'file://localhost/etc/passwd',

    // Other non-authority URIs that should be rejected
    'mailto:test@example.com',
    'tel:+1234567890',
    'sms:+1234567890',
    'about:blank',
  ],
});

// Test 2: Reject dangerous protocols even with require_valid_protocol: false
console.log('\n' + '='.repeat(80));
console.log('Test 2: Reject dangerous protocols even when require_valid_protocol is false');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  args: [{
    require_valid_protocol: false,
  }],
  valid: [
    'http://example.com',
    'https://example.com',
    'custom://example.com', // Custom authority-based protocol
    'myapp://host/path',
  ],
  invalid: [
    // These should STILL be invalid even with require_valid_protocol: false
    // because they are non-authority URIs
    'javascript:alert(1)',
    'data:text/html,<script>alert(1)</script>',
    'vbscript:msgbox(1)',
    'mailto:test@example.com',
  ],
});

// Test 3: RFC 3986 compliant protocol parsing
console.log('\n' + '='.repeat(80));
console.log('Test 3: RFC 3986 compliant protocol parsing');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  args: [{
    protocols: ['http', 'https', 'ws', 'wss', 'custom'],
    require_valid_protocol: true,
  }],
  valid: [
    'http://example.com',
    'https://example.com',
    'ws://example.com',
    'wss://example.com',
    'custom://example.com',
  ],
  invalid: [
    // Invalid because protocol not in whitelist
    'ftp://example.com',
    // Invalid because non-authority URI
    'javascript:alert(1)',
    'data:text/html',
  ],
});

// Test 4: Edge cases in protocol parsing
console.log('\n' + '='.repeat(80));
console.log('Test 4: Edge cases in protocol parsing');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  args: [{
    require_valid_protocol: false,
  }],
  valid: [
    'http://example.com',
    'h2://example.com', // Protocol with digit
    'http+tls://example.com', // Protocol with +
    'my-protocol://example.com', // Protocol with -
    'my.protocol://example.com', // Protocol with .
  ],
  invalid: [
    '123://example.com', // Protocol can't start with digit
    '-protocol://example.com', // Protocol can't start with -
    '.protocol://example.com', // Protocol can't start with .
    'http_proto://example.com', // Protocol can't contain _
    'ht tp://example.com', // Protocol can't contain space
    ':://example.com', // Empty protocol
    'http:/example.com', // Only one slash (malformed)
    'http:example.com', // No slashes (non-authority, rejected)
  ],
});

// Test 5: Ensure backward compatibility for legitimate URLs
console.log('\n' + '='.repeat(80));
console.log('Test 5: Backward compatibility for legitimate URLs');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  valid: [
    'http://www.foobar.com/',
    'https://www.foobar.com/',
    'ftp://www.foobar.com/',
    'http://www.foobar.com:23/',
    'http://user:pass@www.foobar.com/',
    'http://127.0.0.1/',
    'http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/index.html',
    'foobar.com', // No protocol
    'www.foobar.com',
  ],
  invalid: [
    'javascript:alert(1)',
    'data:text/html,test',
  ],
});

// Test 6: Protocol-relative URLs
console.log('\n' + '='.repeat(80));
console.log('Test 6: Protocol-relative URLs still work');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  args: [{
    allow_protocol_relative_urls: true,
  }],
  valid: [
    '//foobar.com',
    '//www.foobar.com/path',
    'http://foobar.com',
  ],
  invalid: [
    'javascript:alert(1)',
    '://foobar.com', // Invalid format
  ],
});

// Test 7: File protocol with proper configuration
console.log('\n' + '='.repeat(80));
console.log('Test 7: File protocol with explicit configuration');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  args: [{
    protocols: ['file'],
    require_host: false,
    require_tld: false,
  }],
  valid: [
    'file://localhost/foo.txt',
    'file:///foo.txt',
    'file:///',
  ],
  invalid: [
    'http://foobar.com',
    'file://', // Empty path
    'javascript:alert(1)', // Still blocked
  ],
});

// Test 8: Specific XSS payloads that were exploitable
console.log('\n' + '='.repeat(80));
console.log('Test 8: Real-world XSS payloads that exploit the vulnerability');
console.log('='.repeat(80));
test({
  validator: 'isURL',
  invalid: [
    // Basic XSS
    'javascript:alert(1)',
    'javascript:alert(document.domain)',
    'javascript:alert(document.cookie)',

    // Obfuscated XSS
    'javascript:alert(String.fromCharCode(88,83,83))',
    'javascript:void(0)',
    'javascript:;',

    // Data URI XSS
    'data:text/html,<script>alert(document.domain)</script>',
    'data:text/html,<img src=x onerror=alert(1)>',
    'data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==',

    // SVG XSS
    'data:image/svg+xml,<svg/onload=alert(1)>',
    'data:image/svg+xml;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+',

    // VBScript (legacy IE)
    'vbscript:msgbox("XSS")',

    // Case variations
    'JaVaScRiPt:alert(1)',
    'DATA:text/html,<script>alert(1)</script>',
  ],
});

console.log('\n' + '='.repeat(80));
console.log('Test suite completed!');
console.log('='.repeat(80));
